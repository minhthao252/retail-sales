<html>
<head>
<title>console_9.sql</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
console_9.sql</font>
</center></td></tr></table>
<pre><span class="s0">#CREATE TABLE THEN IMPORT DATA</span>
<span class="s2">DROP TABLE IF EXISTS </span><span class="s1">retail_sales</span><span class="s2">;</span>
<span class="s2">CREATE TABLE </span><span class="s1">retail_sales</span>
<span class="s1">(</span>
    <span class="s1">sales_month      </span><span class="s2">DATE,</span>
    <span class="s1">naics_code       </span><span class="s2">VARCHAR</span><span class="s1">(</span><span class="s3">255</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">kind_of_business </span><span class="s2">VARCHAR</span><span class="s1">(</span><span class="s3">255</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">reason_for_null  </span><span class="s2">VARCHAR</span><span class="s1">(</span><span class="s3">255</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">sales            </span><span class="s2">DECIMAL</span>
<span class="s1">)</span><span class="s2">;</span>
<span class="s0">###TRENDING THE DATA</span>
<span class="s0">##Simple Trend</span>
<span class="s2">SELECT </span><span class="s1">sales_month</span><span class="s2">, </span><span class="s1">retail_sales.sales</span>
<span class="s2">FROM </span><span class="s1">retail_sales</span>
<span class="s2">WHERE </span><span class="s1">kind_of_business = </span><span class="s4">'Retail and food services sales, total'</span><span class="s2">;</span>
<span class="s0">#transform at yearly level to reduce noise</span>
<span class="s2">SELECT YEAR</span><span class="s1">(retail_sales.sales_month) </span><span class="s2">AS </span><span class="s1">sales_year</span><span class="s2">,</span>
       <span class="s1">SUM(retail_sales.sales) </span><span class="s2">AS </span><span class="s1">sales</span>
<span class="s2">FROM </span><span class="s1">retail_sales</span>
<span class="s2">WHERE </span><span class="s1">kind_of_business = </span><span class="s4">'Retail and food services sales, total'</span>
<span class="s2">GROUP BY </span><span class="s1">sales_year</span><span class="s2">;</span>
<span class="s0">##Comparing components</span>
<span class="s2">SELECT YEAR</span><span class="s1">(retail_sales.sales_month) </span><span class="s2">as </span><span class="s1">sales_year</span><span class="s2">,</span>
       <span class="s1">retail_sales.kind_of_business</span><span class="s2">,</span>
       <span class="s1">SUM(retail_sales.sales) </span><span class="s2">as </span><span class="s1">sales</span>
<span class="s2">FROM </span><span class="s1">retail_sales</span>
<span class="s2">WHERE </span><span class="s1">kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Book stores'</span><span class="s2">, </span><span class="s4">'Sporting goods stores'</span><span class="s2">, </span><span class="s4">'Hobby, toy, and game stores'</span><span class="s1">)</span>
<span class="s2">GROUP BY </span><span class="s1">sales_year</span><span class="s2">, </span><span class="s1">kind_of_business</span><span class="s2">;</span>
<span class="s0">#Compare women and mens sales</span>
<span class="s2">SELECT YEAR</span><span class="s1">(retail_sales.sales_month) </span><span class="s2">as </span><span class="s1">sales_year</span><span class="s2">,</span>
       <span class="s1">sum(</span><span class="s2">case when </span><span class="s1">retail_sales.kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores' </span><span class="s2">then </span><span class="s1">sales </span><span class="s2">end</span><span class="s1">) </span><span class="s2">as </span><span class="s1">womens_sales</span><span class="s2">,</span>
       <span class="s1">sum(</span><span class="s2">case when </span><span class="s1">retail_sales.kind_of_business = </span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores' </span><span class="s2">then </span><span class="s1">sales </span><span class="s2">end</span><span class="s1">) </span><span class="s2">as </span><span class="s1">mens_sales</span>
<span class="s2">FROM </span><span class="s1">retail_sales</span>
<span class="s2">WHERE </span><span class="s1">kind_of_business </span><span class="s2">in </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span>
     <span class="s2">,</span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span>
    <span class="s2">and </span><span class="s1">sales_month &lt;= </span><span class="s4">'2019-12-01'</span>
    <span class="s2">GROUP BY </span><span class="s1">sales_year</span><span class="s2">;</span>
<span class="s0">#ecart of women and men sales</span>

<span class="s2">SELECT YEAR</span><span class="s1">(retail_sales.sales_month) </span><span class="s2">as </span><span class="s1">sales_year</span><span class="s2">,</span>
       <span class="s1">sum(</span><span class="s2">case when </span><span class="s1">retail_sales.kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores' </span><span class="s2">then </span><span class="s1">sales </span><span class="s2">end</span><span class="s1">) - sum(</span><span class="s2">case when </span><span class="s1">retail_sales.kind_of_business = </span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores' </span><span class="s2">then </span><span class="s1">sales </span><span class="s2">end</span><span class="s1">) </span><span class="s2">as </span><span class="s1">ecart_gender_sell</span>
<span class="s2">FROM </span><span class="s1">retail_sales</span>
<span class="s2">WHERE </span><span class="s1">kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">, </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span>
  <span class="s2">AND </span><span class="s1">sales_month &lt;= </span><span class="s4">'2019-12-01'</span>
<span class="s2">GROUP BY </span><span class="s1">sales_year</span><span class="s2">;</span>
<span class="s0">#calculate the ratio of women and men clothing sales</span>
<span class="s2">SELECT </span><span class="s1">sales_year</span><span class="s2">,</span>
       <span class="s1">womens_sales / mens_sales </span><span class="s2">AS </span><span class="s1">womens_times_of_mens</span>
<span class="s2">FROM </span><span class="s1">(</span>
    <span class="s2">SELECT YEAR</span><span class="s1">(sales_month) </span><span class="s2">AS </span><span class="s1">sales_year</span><span class="s2">,</span>
           <span class="s1">SUM(</span><span class="s2">CASE WHEN </span><span class="s1">kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores' </span><span class="s2">THEN </span><span class="s1">sales </span><span class="s2">END</span><span class="s1">) </span><span class="s2">AS </span><span class="s1">womens_sales</span><span class="s2">,</span>
           <span class="s1">SUM(</span><span class="s2">CASE WHEN </span><span class="s1">kind_of_business = </span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores' </span><span class="s2">THEN </span><span class="s1">sales </span><span class="s2">END</span><span class="s1">) </span><span class="s2">AS </span><span class="s1">mens_sales</span>
    <span class="s2">FROM </span><span class="s1">retail_sales</span>
    <span class="s2">WHERE </span><span class="s1">kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">, </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span>
      <span class="s2">AND </span><span class="s1">sales_month &lt;= </span><span class="s4">'2019-12-01'</span>
    <span class="s2">GROUP BY </span><span class="s1">sales_year</span>
<span class="s1">) </span><span class="s2">AS </span><span class="s1">a</span><span class="s2">;</span>
<span class="s0">##Percent of Total Calculations using join</span>
<span class="s2">SELECT</span>
    <span class="s1">a.sales_month</span><span class="s2">,</span>
    <span class="s1">a.kind_of_business</span><span class="s2">,</span>
    <span class="s1">a.sales</span><span class="s2">,</span>
    <span class="s1">(a.sales * </span><span class="s3">100 </span><span class="s1">/ total_sales.total_sales) </span><span class="s2">AS </span><span class="s1">pct_total_sales</span>
<span class="s2">FROM</span>
    <span class="s1">retail_sales a</span>
<span class="s2">JOIN </span><span class="s1">(</span>
    <span class="s2">SELECT</span>
        <span class="s1">sales_month</span><span class="s2">,</span>
        <span class="s1">SUM(sales) </span><span class="s2">AS </span><span class="s1">total_sales</span>
    <span class="s2">FROM</span>
        <span class="s1">retail_sales</span>
    <span class="s2">WHERE</span>
        <span class="s1">kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">, </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span>
    <span class="s2">GROUP BY</span>
        <span class="s1">sales_month</span>
<span class="s1">) </span><span class="s2">AS </span><span class="s1">total_sales </span><span class="s2">ON </span><span class="s1">a.sales_month = total_sales.sales_month</span>
<span class="s2">WHERE</span>
    <span class="s1">a.kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">, </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span><span class="s2">;</span>
<span class="s0">#using window function (more practice</span>
<span class="s2">SELECT</span>
    <span class="s1">sales_month</span><span class="s2">,</span>
    <span class="s1">kind_of_business</span><span class="s2">,</span>
    <span class="s1">sales</span><span class="s2">,</span>
    <span class="s1">SUM(sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">PARTITION BY </span><span class="s1">sales_month) </span><span class="s2">AS </span><span class="s1">total_sales</span><span class="s2">,</span>
    <span class="s1">sales * </span><span class="s3">100 </span><span class="s1">/ SUM(sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">PARTITION BY </span><span class="s1">sales_month) </span><span class="s2">AS </span><span class="s1">pct_total </span><span class="s0">#have to use window function in this case to specify the partition by sales_month</span>
<span class="s2">FROM</span>
    <span class="s1">retail_sales</span>
<span class="s2">WHERE</span>
    <span class="s1">kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">, </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span><span class="s2">;</span>

<span class="s0">##the percent of yearly sales each month represents</span>
<span class="s0">#using join (The query is designed to find, for each month and type of business, the percentage of yearly sales that each month’s sales represent by compare itself)</span>
<span class="s2">SELECT</span>
    <span class="s1">sales_month</span><span class="s2">,</span>
    <span class="s1">kind_of_business</span><span class="s2">,</span>
    <span class="s1">sales * </span><span class="s3">100 </span><span class="s1">/ yearly_sales </span><span class="s2">AS </span><span class="s1">pct_yearly</span>
<span class="s2">FROM </span><span class="s1">(</span>
    <span class="s2">SELECT</span>
        <span class="s1">a.sales_month</span><span class="s2">,</span>
        <span class="s1">a.kind_of_business</span><span class="s2">,</span>
        <span class="s1">a.sales</span><span class="s2">,</span>
        <span class="s1">SUM(b.sales) </span><span class="s2">AS </span><span class="s1">yearly_sales</span>
    <span class="s2">FROM</span>
        <span class="s1">retail_sales a</span>
    <span class="s2">JOIN</span>
        <span class="s1">retail_sales b</span>
    <span class="s2">ON</span>
        <span class="s2">YEAR</span><span class="s1">(a.sales_month) = </span><span class="s2">YEAR</span><span class="s1">(b.sales_month)</span>
        <span class="s2">AND </span><span class="s1">a.kind_of_business = b.kind_of_business</span>
    <span class="s2">WHERE</span>
        <span class="s1">a.kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">, </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span>
    <span class="s2">GROUP BY</span>
        <span class="s1">a.sales_month</span><span class="s2">, </span><span class="s1">a.kind_of_business</span><span class="s2">, </span><span class="s1">a.sales</span>
<span class="s1">) </span><span class="s2">AS </span><span class="s1">aa</span><span class="s2">;</span>
<span class="s0">#using window function</span>
<span class="s2">SELECT</span>
    <span class="s1">sales_month</span><span class="s2">,</span>
    <span class="s1">kind_of_business</span><span class="s2">,</span>
    <span class="s1">sales</span><span class="s2">,</span>
    <span class="s1">SUM(sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">PARTITION BY YEAR</span><span class="s1">(sales_month)</span><span class="s2">, </span><span class="s1">kind_of_business) </span><span class="s2">AS </span><span class="s1">yearly_sales</span><span class="s2">,</span>
    <span class="s1">sales * </span><span class="s3">100 </span><span class="s1">/ SUM(sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">PARTITION BY YEAR</span><span class="s1">(sales_month)</span><span class="s2">, </span><span class="s1">kind_of_business) </span><span class="s2">AS </span><span class="s1">pct_yearly</span>
<span class="s2">FROM</span>
    <span class="s1">retail_sales</span>
<span class="s2">WHERE</span>
    <span class="s1">kind_of_business </span><span class="s2">IN </span><span class="s1">(</span><span class="s4">'Men</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">, </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s1">)</span><span class="s2">;</span>
<span class="s0">##Indexing to See Percent Change over Time</span>
<span class="s0">#using first_value window function (using to find the first value associated with the first row in the PARTITION Clause acoording to the sort in ORDER BY)</span>
<span class="s2">SELECT </span><span class="s1">sales_year</span><span class="s2">, </span><span class="s1">sales</span><span class="s2">,</span>
       <span class="s2">first_value</span><span class="s1">(sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">ORDER BY </span><span class="s1">sales_year) </span><span class="s2">as </span><span class="s1">index_table </span><span class="s0">#partiton by allows to segment your dataset into distinct groups while order by returns the  value from the first year in the sorted list of years.</span>
<span class="s2">FROM</span>
    <span class="s1">(</span><span class="s2">SELECT YEAR</span><span class="s1">(retail_sales.sales_month) </span><span class="s2">as </span><span class="s1">sales_year</span><span class="s2">,</span>
            <span class="s1">SUM(retail_sales.sales) </span><span class="s2">as </span><span class="s1">sales</span>
    <span class="s2">FROM </span><span class="s1">retail_sales</span>
    <span class="s2">WHERE </span><span class="s1">kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span>
    <span class="s2">GROUP BY </span><span class="s1">sales_year) a</span><span class="s2">;</span>
<span class="s0">#the percentage change in sales from the first year in the dataset</span>
<span class="s2">SELECT </span><span class="s1">sales_year</span><span class="s2">, </span><span class="s1">sales</span><span class="s2">,</span>
       <span class="s1">(sales / </span><span class="s2">FIRST_VALUE</span><span class="s1">(sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">ORDER BY </span><span class="s1">sales_year) - </span><span class="s3">1</span><span class="s1">) * </span><span class="s3">100 </span><span class="s2">AS </span><span class="s1">pct_from_index</span>
<span class="s2">FROM</span>
<span class="s1">(</span>
    <span class="s2">SELECT YEAR</span><span class="s1">(sales_month) </span><span class="s2">AS </span><span class="s1">sales_year</span><span class="s2">,</span>
           <span class="s1">SUM(sales) </span><span class="s2">AS </span><span class="s1">sales</span>
    <span class="s2">FROM </span><span class="s1">retail_sales</span>
    <span class="s2">WHERE </span><span class="s1">kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span>
    <span class="s2">GROUP BY </span><span class="s1">sales_year</span>
<span class="s1">) </span><span class="s2">AS </span><span class="s1">a</span><span class="s2">;</span>
<span class="s0">#using JOIN</span>
<span class="s2">SELECT </span><span class="s1">sales_year</span><span class="s2">, </span><span class="s1">sales</span><span class="s2">, </span><span class="s0">#4</span>
       <span class="s1">(sales / index_sales - </span><span class="s3">1</span><span class="s1">) * </span><span class="s3">100 </span><span class="s2">AS </span><span class="s1">pct_from_index</span>
<span class="s2">FROM</span>
<span class="s1">(</span>
    <span class="s2">SELECT YEAR</span><span class="s1">(aa.sales_month) </span><span class="s2">AS </span><span class="s1">sales_year</span><span class="s2">, </span><span class="s0">#3</span>
           <span class="s1">bb.index_sales</span><span class="s2">,</span>
           <span class="s1">SUM(aa.sales) </span><span class="s2">AS </span><span class="s1">sales</span>
    <span class="s2">FROM </span><span class="s1">retail_sales aa</span>
    <span class="s2">CROSS JOIN</span>
    <span class="s1">(</span>
        <span class="s2">SELECT </span><span class="s1">SUM(a.sales) </span><span class="s2">AS </span><span class="s1">index_sales </span><span class="s0">#1</span>
        <span class="s2">FROM </span><span class="s1">retail_sales a</span>
        <span class="s2">JOIN</span>
        <span class="s1">(</span>
            <span class="s2">SELECT </span><span class="s1">MIN(</span><span class="s2">YEAR</span><span class="s1">(sales_month)) </span><span class="s2">AS </span><span class="s1">first_year </span><span class="s0">#2</span>
            <span class="s2">FROM </span><span class="s1">retail_sales</span>
            <span class="s2">WHERE </span><span class="s1">kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span>
        <span class="s1">) b </span><span class="s2">ON YEAR</span><span class="s1">(a.sales_month) = b.first_year</span>
        <span class="s2">WHERE </span><span class="s1">a.kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span>
    <span class="s1">) bb</span>
    <span class="s2">WHERE </span><span class="s1">aa.kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span>
    <span class="s2">GROUP BY </span><span class="s1">sales_year</span><span class="s2">, </span><span class="s1">bb.index_sales</span>
<span class="s1">) aaa</span><span class="s2">;</span>

<span class="s0">###Rolling Time Windows -  moving calculations, that take into account multiple periods.</span>
<span class="s0">##Calculating Rolling Time Windows</span>
<span class="s0">#using join function and interval function</span>
<span class="s2">SELECT </span><span class="s1">a.sales_month </span><span class="s2">as </span><span class="s1">start_date</span><span class="s2">,</span>
       <span class="s1">a.sales</span><span class="s2">,</span>
       <span class="s1">b.sales_month </span><span class="s2">as </span><span class="s1">end_of_periode</span><span class="s2">,</span>
       <span class="s1">b.sales </span><span class="s2">as </span><span class="s1">rolling_sales</span>
<span class="s2">FROM </span><span class="s1">retail_sales a</span>
<span class="s2">JOIN </span><span class="s1">retail_sales b </span><span class="s2">on </span><span class="s1">a.kind_of_business = b.kind_of_business</span>
    <span class="s2">AND </span><span class="s1">b.sales_month </span><span class="s2">BETWEEN </span><span class="s1">a.sales_month - </span><span class="s2">INTERVAL </span><span class="s3">11 </span><span class="s2">MONTH </span><span class="s0">#defines the rolling 12-month window, ending at a.sales_month and looking back 11 months.</span>
    <span class="s2">AND </span><span class="s1">a.sales_month</span>
<span class="s2">WHERE </span><span class="s1">a.sales_month = </span><span class="s4">'2019-12-01'</span>
   <span class="s2">AND </span><span class="s1">b.kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span>
   <span class="s2">AND </span><span class="s1">a.kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">;</span>
<span class="s0">#apply average aggregate and count function to calculate avarage sales each periode (in a row)</span>
<span class="s2">SELECT</span>
    <span class="s1">sales_month</span><span class="s2">,</span>
    <span class="s1">AVG(retail_sales.sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">ORDER BY </span><span class="s1">retail_sales.sales_month </span><span class="s2">ROWS BETWEEN </span><span class="s3">11 </span><span class="s2">PRECEDING AND CURRENT ROW</span><span class="s1">) </span><span class="s2">AS </span><span class="s1">avg_sales</span><span class="s2">,</span>
    <span class="s2">COUNT</span><span class="s1">(retail_sales.sales) </span><span class="s2">OVER </span><span class="s1">(</span><span class="s2">ORDER BY </span><span class="s1">retail_sales.sales_month </span><span class="s2">ROWS BETWEEN </span><span class="s3">11 </span><span class="s2">PRECEDING AND CURRENT ROW</span><span class="s1">) </span><span class="s2">AS </span><span class="s1">records_count</span>
<span class="s2">FROM</span>
    <span class="s1">retail_sales</span>
<span class="s2">WHERE</span>
    <span class="s1">kind_of_business = </span><span class="s4">'Women</span><span class="s1">''</span><span class="s4">s clothing stores'</span><span class="s2">;</span>
</pre>
</body>
</html>